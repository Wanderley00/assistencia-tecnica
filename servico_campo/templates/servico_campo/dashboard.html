{% extends 'servico_campo/base.html' %}
{% load i18n %}

{% block title %}Dashboard - {{ block.super }}{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Ordens de Serviço</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* --- ESTILOS GERAIS --- */

        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 2px;
        }

        /* --- HEADER MODERNIZADO --- */
        .dashboard-header {
            background: linear-gradient(135deg, #009AD1 0%, #00628A 100%);
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="90" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .dashboard-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }

        .dashboard-subtitle {
            font-size: 1.0rem;
            opacity: 0.9;
            margin: 10px 0 0 0;
            position: relative;
            z-index: 2;
        }

        .welcome-text {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 2;
        }

        /* --- CARDS DE MÉTRICAS MODERNIZADOS --- */
        .metrics-section {
            padding: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            height: 100%;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-accent, #6c757d);
            border-radius: 20px 20px 0 0;
        }

        .metric-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .metric-card.warning { --card-accent: linear-gradient(135deg, #ffc107, #fd7e14); }
        .metric-card.info { --card-accent: linear-gradient(135deg, #009AD1, #00628A); }
        .metric-card.success { --card-accent: linear-gradient(135deg, #28a745, #20c997); }
        .metric-card.danger { --card-accent: linear-gradient(135deg, #dc3545, #e83e8c); }


        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 20px;
            background: var(--card-accent, #6c757d);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #212529;
            margin: 0;
            line-height: 1;
        }

        .metric-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6c757d;
            margin: 10px 0 0 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f1f3f4;
        }

        .metric-footer a {
            color: #495057;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .metric-footer a:hover {
            color: #212529;
            transform: translateX(5px);
        }

        /* --- TABELA MODERNIZADA --- */
        .table-section {
            padding: 0 30px 30px;
        }

        .modern-table-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .table-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px 30px;
            border-bottom: 1px solid #dee2e6;
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #212529;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .custom-table {
            margin: 0;
            font-size: 0.9rem;
        }

        .custom-table thead th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
            padding: 20px 25px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.8rem;
        }

        .custom-table tbody td {
            padding: 20px 25px;
            border: none;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        .custom-table tbody tr:hover {
            background: rgba(0, 154, 209, 0.05);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .custom-table a {
            color: #009AD1;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }
        .custom-table a:hover {
            color: #00628A;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* --- SEÇÕES DE LISTAS MODERNIZADAS --- */
        .lists-section {
            padding: 0 30px 30px;
        }

        .list-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: 100%;
        }

        .list-header {
            /* PALETA AZUL */
            background: linear-gradient(135deg, #009AD1 0%, #00628A 100%);
            color: white;
            padding: 10px 25px;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modern-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .modern-list-item {
            padding: 20px 25px;
            border: none;
            border-bottom: 1px solid #f1f3f4;
            transition: all 0.2s ease;
            text-decoration: none;
            display: block;
            color: inherit;
        }

        .modern-list-item:hover {
            background: rgba(0, 154, 209, 0.05);
            transform: translateX(5px);
            color: inherit;
        }

        .list-item-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin: 0 0 8px 0;
        }

        .list-item-subtitle {
            color: #6c757d;
            font-size: 0.8rem;
            margin: 0;
        }

        .empty-list-item {
            padding: 40px 25px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        .empty-chart-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }


        /* --- GRÁFICOS MODERNIZADOS --- */
        .charts-section {
            padding: 0 30px 30px;
        }

        .chart-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: 100%;
        }

        .chart-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px 25px;
            border-bottom: 1px solid #dee2e6;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #212529;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* --- SCROLL PERSONALIZADO --- */
        .modern-list::-webkit-scrollbar {
            width: 6px;
        }

        .modern-list::-webkit-scrollbar-track {
            background: #f1f3f4;
        }

        .modern-list::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #009AD1, #00628A);
            border-radius: 3px;
        }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            .dashboard-container {
                /* Ajuste para ocupar a tela inteira */
                margin: 0px -14px;
                border-radius: 15;
                box-shadow: none; /* Remove a sombra em telas pequenas */
            }

            .dashboard-header {
                padding: 20px 15px; /* Adiciona um padding lateral mínimo */
                border-radius: 0;
            }

            .dashboard-title {
                font-size: 1.8rem; /* Reduz um pouco para caber melhor */
            }

            .metrics-section,
            .table-section,
            .lists-section,
            .charts-section {
                /* Reduz o padding para dar mais espaço ao conteúdo */
                padding: 15px;
            }

            .metric-card {
                margin-bottom: 15px;
            }

            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="dashboard-container">
            <!-- Header Modernizado -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">
                    <i class="bi bi-speedometer2 me-3"></i>
                    Dashboard
                </h1>
                <p class="dashboard-subtitle">
                    Central de controle e monitoramento de ordens de serviço
                </p>
                <div class="welcome-text">
                    <i class="bi bi-person-circle me-2"></i>
                    Olá, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}. Bem-vindo de volta!
                </div>
            </div>

            <!-- Cards de Métricas -->
            <div class="metrics-section">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-4 fade-in-up">
                        <div class="metric-card warning">
                            <div class="metric-icon">
                                <i class="bi bi-play-circle-fill"></i>
                            </div>
                            <h2 class="metric-value">{{ ordens_em_execucao_count }}</h2>
                            <p class="metric-title">Ordens em Execução</p>
                            <div class="metric-footer">
                                <a href="{% url 'servico_campo:lista_os' %}?status=EM_EXECUCAO">
                                    Ver detalhes
                                    <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4 fade-in-up">
                        <div class="metric-card info">
                            <div class="metric-icon">
                                <i class="bi bi-gear-fill"></i>
                            </div>
                            <h2 class="metric-value">{{ equipamentos_count }}</h2>
                            <p class="metric-title">Ativos Cadastrados</p>
                            <div class="metric-footer">
                                <a href="{% url 'servico_campo:lista_equipamentos' %}">
                                    Ver detalhes
                                    <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4 fade-in-up">
                        <div class="metric-card success">
                            <div class="metric-icon">
                                <i class="bi bi-currency-dollar"></i>
                            </div>
                            <h2 class="metric-value">R$ {{ custo_total_reembolso|floatformat:2 }}</h2>
                            <p class="metric-title">Custo com Despesas</p>
                            <div class="metric-footer">
                                <span style="color: #6c757d; font-size: 0.85rem;">Total em despesas registradas</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4 fade-in-up">
                        <div class="metric-card danger">
                            <div class="metric-icon">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            </div>
                            <h2 class="metric-value">{{ despesas_pendentes_count }}</h2>
                            <p class="metric-title">Despesas Pendentes</p>
                            <div class="metric-footer">
                                <a href="{% url 'servico_campo:lista_despesas_pendentes' %}">
                                    Aprovar agora
                                    <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Últimos Serviços -->
            <div class="table-section">
                <div class="modern-table-card fade-in-up">
                    <div class="table-header">
                        <h5 class="table-title">
                            <i class="bi bi-list-check"></i>
                            Últimos Serviços por Ativo
                        </h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table custom-table">
                            <thead>
                                <tr>
                                    <th>Ativo</th>
                                    <th>Último Serviço (OS)</th>
                                    <th>Tipo</th>
                                    <th>Data de Conclusão</th>
                                    <th>Responsável pela Obra</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in ultimas_manutencoes_por_ativo %}
                                    <tr>
                                        <td>
                                            <strong>{{ item.equipamento.nome }}</strong>
                                        </td>
                                        {% if item.ultima_os %}
                                            <td>
                                                <a href="{% url 'servico_campo:detalhe_os' item.ultima_os.pk %}" 
                                                   style="color: #667eea; text-decoration: none; font-weight: 600;">
                                                    {{ item.ultima_os.titulo_servico }}
                                                </a>
                                            </td>
                                            <td>
                                                <span class="status-badge bg-secondary">
                                                    {{ item.ultima_os.tipo_manutencao.nome }}
                                                </span>
                                            </td>
                                            <td>{{ item.ultima_os.data_fechamento|date:"d/m/Y" }}</td>
                                            <td>{{ item.ultima_os.tecnico_responsavel.get_full_name|default:"N/A" }}</td>
                                        {% else %}
                                            <td colspan="4" class="text-muted fst-italic">
                                                Nenhum serviço concluído registrado.
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center p-4 text-muted">
                                            <i class="bi bi-inbox me-2"></i>
                                            Nenhum ativo cadastrado.
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Listas de Ordens de Serviço -->
            <div class="lists-section">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="list-card fade-in-up">
                            <div class="list-header">
                                <i class="bi bi-calendar-plus"></i>
                                Minhas Próximas Ordens de Serviço
                            </div>
                            <div class="modern-list">
                                {% for os in minhas_os_planejadas %}
                                    <a href="{% url 'servico_campo:detalhe_os' os.pk %}" class="modern-list-item">
                                        <div class="list-item-title">{{ os.numero_os }} - {{ os.cliente.razao_social }}</div>
                                        <div class="list-item-subtitle">
                                            <i class="bi bi-calendar-event me-1"></i>
                                            Previsão: {{ os.data_previsao_conclusao|date:"d/m/Y" }}
                                        </div>
                                    </a>
                                {% empty %}
                                    <div class="empty-list-item">
                                        <i class="bi bi-calendar-x me-2"></i>
                                        Você não tem Ordens de Serviço planejadas.
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="list-card fade-in-up">
                            <div class="list-header">
                                <i class="bi bi-check-circle"></i>
                                Últimas OS Concluídas
                            </div>
                            <div class="modern-list">
                                {% for os in ultimas_os_concluidas %}
                                    <a href="{% url 'servico_campo:detalhe_os' os.pk %}" class="modern-list-item">
                                        <div class="list-item-title">{{ os.numero_os }} - {{ os.cliente.razao_social }}</div>
                                        <div class="list-item-subtitle">
                                            <i class="bi bi-check-circle-fill me-1"></i>
                                            Concluída em: {{ os.data_fechamento|date:"d/m/Y" }}
                                        </div>
                                    </a>
                                {% empty %}
                                    <div class="empty-list-item">
                                        <i class="bi bi-clipboard-x me-2"></i>
                                        Nenhuma OS concluída recentemente.
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="charts-section">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="chart-card fade-in-up">
                            <div class="chart-header">
                                <h5 class="chart-title">
                                    <i class="bi bi-pie-chart"></i>
                                    Ordens de Serviço por Status
                                </h5>
                            </div>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                                <div id="no-data-status" class="empty-chart-message" style="display: none;">
                                    <i class="bi bi-info-circle me-2"></i>Não há dados de status para exibir.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="chart-card fade-in-up">
                            <div class="chart-header">
                                <h5 class="chart-title">
                                    <i class="bi bi-bar-chart"></i>
                                    Serviço de Campo
                                </h5>
                            </div>
                            <div class="chart-body">
                                <div class="chart-container">
                                    <canvas id="tipoManutencaoChart"></canvas>
                                    <div id="no-data-tipo" class="empty-chart-message" style="display: none;">
                                        <i class="bi bi-info-circle me-2"></i>Não há dados de serviço para exibir.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts dos gráficos (mantido igual ao original) -->
    {{ status_labels|json_script:"status-labels" }}
    {{ status_counts|json_script:"status-counts" }}
    {{ status_colors|json_script:"status-colors" }}
    {{ tipo_labels|json_script:"tipo-labels" }}
    {{ tipo_counts|json_script:"tipo-counts" }}
    {{ tipo_colors|json_script:"tipo-colors" }}

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const statusLabels = JSON.parse(document.getElementById('status-labels').textContent);
        const statusCounts = JSON.parse(document.getElementById('status-counts').textContent);
        const statusColors = JSON.parse(document.getElementById('status-colors').textContent);
        const tipoLabels = JSON.parse(document.getElementById('tipo-labels').textContent);
        const tipoCounts = JSON.parse(document.getElementById('tipo-counts').textContent);
        const tipoColors = JSON.parse(document.getElementById('tipo-colors').textContent);

        // Configurações globais do Chart.js
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.font.size = 12;

        // Gráfico de Status
        const ctxStatus = document.getElementById('statusChart');
        const noDataStatusDiv = document.getElementById('no-data-status');
        // Verifica se a soma dos dados é maior que 0
        if (ctxStatus && statusCounts.reduce((a, b) => a + b, 0) > 0) {
            new Chart(ctxStatus.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusCounts,
                        backgroundColor: statusColors,
                        borderColor: '#fff',
                        borderWidth: 3,
                        hoverBorderWidth: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    // ADICIONE ESTA SEÇÃO "layout"
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        } else if (ctxStatus) {
            // Se não houver dados, esconde o canvas e mostra a mensagem
            ctxStatus.style.display = 'none';
            noDataStatusDiv.style.display = 'flex';
        }

        // Gráfico de Tipo de Manutenção
        const ctxTipo = document.getElementById('tipoManutencaoChart');
        const noDataTipoDiv = document.getElementById('no-data-tipo');
        // Verifica se a soma dos dados é maior que 0
        if (ctxTipo && tipoCounts.reduce((a, b) => a + b, 0) > 0) {
            new Chart(ctxTipo.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: tipoLabels,
                    datasets: [{
                        label: 'Quantidade de OSs',
                        data: tipoCounts,
                        backgroundColor: tipoColors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        } else if (ctxTipo) {
            // Se não houver dados, esconde o canvas e mostra a mensagem
            ctxTipo.style.display = 'none';
            noDataTipoDiv.style.display = 'flex';
        }

        // Animação de entrada para os cards (mantida do seu código original)
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        document.querySelectorAll('.fade-in-up').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(30px)';
            el.style.transition = 'all 0.6s ease';
            observer.observe(el);
        });
    });
    </script>
</body>
</html>
{% endblock %}